<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Online Poker</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
            min-height: 100vh;
        }
        #pokerSvg {
            width: 800px;
            height: 600px;
        }
        #controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: #1a73e8;
            color: white;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }
        button:hover {
            background: #1557b0;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #betOptions {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        #betOptions button {
            padding: 8px 15px;
            font-size: 14px;
        }
        #customBet {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 80px;
        }
        .chip-box {
            padding: 5px 10px;
            background: #fff;
            border: 1px solid #333;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }
        #pastHandsBtn {
            position: absolute;
            bottom: -60px;
            left: 0;
        }
        #pastHandsMenu {
            display: none;
            position: absolute;
            bottom: -50px;
            left: 120px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 10px;
            z-index: 10;
        }
        .hand-entry {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .timer-bar {
            width: 60px;
            height: 5px;
            background: #ccc;
            position: absolute;
        }
        .timer-progress {
            height: 100%;
            background: #1a73e8;
            transition: width linear;
        }
    </style>
</head>
<body>
    <svg id="pokerSvg" viewBox="0 0 800 600"></svg>
    <div id="controls">
        <button id="sitDownBtn" onclick="sitDown()">Sit Down</button>
        <button id="betBtn" onclick="toggleBetOptions()" disabled>Bet</button>
        <button id="checkBtn" onclick="check()" disabled>Check</button>
        <button id="foldBtn" onclick="fold()" disabled>Fold</button>
        <button id="nextBtn" onclick="advanceGame()" disabled>Next</button>
        <div id="betOptions" style="display: none;">
            <button onclick="bet(10)">10</button>
            <button onclick="bet(Math.floor(pot / 4))">1/4 Pot</button>
            <button onclick="bet(Math.floor(pot / 2))">1/2 Pot</button>
            <button onclick="bet(pot)">Pot</button>
            <button onclick="betAllIn()">All-In</button>
            <input id="customBet" type="number" min="1" placeholder="Custom">
            <button onclick="betCustom()">Go</button>
        </div>
        <button id="pastHandsBtn" onclick="togglePastHands()">Past Hands</button>
        <div id="pastHandsMenu"></div>
    </div>

    <script>
        const socket = io();
        const svg = document.getElementById('pokerSvg');
        const sitDownBtn = document.getElementById('sitDownBtn');
        const betBtn = document.getElementById('betBtn');
        const checkBtn = document.getElementById('checkBtn');
        const foldBtn = document.getElementById('foldBtn');
        const nextBtn = document.getElementById('nextBtn');
        const betOptions = document.getElementById('betOptions');
        const pastHandsMenu = document.getElementById('pastHandsMenu');

        // Game state
        let gameState = {
            players: [],
            communityCards: [],
            gameStage: 'waiting',
            pot: 0,
            currentPlayerIndex: 0,
            dealerIndex: 0,
            hasBetThisRound: new Set(),
            pastHands: [],
            currentHandBets: { preflop: [], flop: [], turn: [], river: [] }
        };
        let myPlayerId = null;
        let timerInterval = null;

        socket.on('update', (state) => {
            gameState = state;
            gameState.hasBetThisRound = new Set(state.hasBetThisRound); // Convert array to Set
            myPlayerId = socket.id;
            drawScene();
            if (gameState.players.length > 0 && gameState.gameStage !== 'waiting' && gameState.gameStage !== 'showdown') {
                startTimer();
            }
        });

        function drawScene() {
            svg.innerHTML = '';

            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const dimFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
            dimFilter.setAttribute('id', 'dim');
            dimFilter.innerHTML = '<feColorMatrix type="matrix" values="0.5 0 0 0 0  0 0.5 0 0 0  0 0 0.5 0 0  0 0 0 0.5 0"/>';
            defs.appendChild(dimFilter);

            const glowFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
            glowFilter.setAttribute('id', 'glow');
            glowFilter.innerHTML = `
                <feGaussianBlur stdDeviation="2.5" result="blur"/>
                <feMerge>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            `;
            defs.appendChild(glowFilter);
            svg.appendChild(defs);

            const table = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
            table.setAttribute('cx', '400');
            table.setAttribute('cy', '300');
            table.setAttribute('rx', '300');
            table.setAttribute('ry', '200');
            table.setAttribute('fill', 'url(#tableGradient)');
            if (gameState.gameStage === 'showdown') table.setAttribute('filter', 'url(#dim)');
            svg.appendChild(table);

            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
            gradient.setAttribute('id', 'tableGradient');
            gradient.innerHTML = `
                <stop offset="0%" style="stop-color: #2e7d32;" />
                <stop offset="100%" style="stop-color: #1b5e20;" />
            `;
            defs.appendChild(gradient);

            const cardWidth = 60;
            const cardSpacing = 10;
            const totalWidth = gameState.communityCards.length * cardWidth + (gameState.communityCards.length - 1) * cardSpacing;
            const startX = 400 - totalWidth / 2;
            gameState.communityCards.forEach((card, i) => {
                drawCard(card, startX + i * (cardWidth + cardSpacing), 270, gameState.gameStage === 'showdown');
            });

            gameState.players.forEach((player, i) => {
                const angle = (i / 6) * 2 * Math.PI;
                const x = 400 + 250 * Math.cos(angle);
                const y = 300 + 150 * Math.sin(angle);

                if (i === gameState.dealerIndex) {
                    const dealer = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    dealer.setAttribute('cx', x);
                    dealer.setAttribute('cy', y - 40);
                    dealer.setAttribute('r', '10');
                    dealer.setAttribute('fill', '#000');
                    svg.appendChild(dealer);
                    const dealerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    dealerText.setAttribute('x', x);
                    dealerText.setAttribute('y', y - 36);
                    dealerText.setAttribute('text-anchor', 'middle');
                    dealerText.setAttribute('fill', '#fff');
                    dealerText.setAttribute('font-size', '12');
                    dealerText.textContent = 'D';
                    svg.appendChild(dealerText);
                }

                const nameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                nameText.setAttribute('x', x);
                nameText.setAttribute('y', y + 120);
                nameText.setAttribute('text-anchor', 'middle');
                nameText.setAttribute('fill', '#000');
                nameText.setAttribute('font-size', '16');
                nameText.textContent = player.name;
                svg.appendChild(nameText);

                const chipBox = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                chipBox.setAttribute('x', x - 40);
                chipBox.setAttribute('y', y + 130);
                chipBox.setAttribute('width', '80');
                chipBox.setAttribute('height', '25');
                chipBox.setAttribute('fill', '#fff');
                chipBox.setAttribute('stroke', '#333');
                chipBox.setAttribute('stroke-width', '1');
                chipBox.setAttribute('rx', '5');
                svg.appendChild(chipBox);

                const chipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                chipText.setAttribute('x', x);
                chipText.setAttribute('y', y + 148);
                chipText.setAttribute('text-anchor', 'middle');
                chipText.setAttribute('fill', '#000');
                chipText.setAttribute('font-size', '14');
                chipText.textContent = player.chips;
                svg.appendChild(chipText);

                if (i === gameState.currentPlayerIndex && gameState.gameStage !== 'waiting' && gameState.gameStage !== 'showdown') {
                    const timerBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    timerBar.setAttribute('x', x - 30);
                    timerBar.setAttribute('y', y + 160);
                    timerBar.setAttribute('width', '60');
                    timerBar.setAttribute('height', '5');
                    timerBar.setAttribute('fill', '#ccc');
                    timerBar.classList.add('timer-bar');
                    svg.appendChild(timerBar);

                    const progress = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    progress.setAttribute('x', x - 30);
                    progress.setAttribute('y', y + 160);
                    progress.setAttribute('width', '60');
                    progress.setAttribute('height', '5');
                    progress.setAttribute('fill', '#1a73e8');
                    progress.classList.add('timer-progress');
                    svg.appendChild(progress);
                }

                if (player.cards) {
                    const showCards = player.id === myPlayerId || gameState.gameStage === 'showdown';
                    const isWinner = gameState.gameStage === 'showdown' && i === gameState.currentPlayerIndex;
                    drawCard(showCards ? player.cards[0] : '?', x - 45, y - 25, !isWinner && gameState.gameStage === 'showdown', isWinner);
                    drawCard(showCards ? player.cards[1] : '?', x + 15, y - 25, !isWinner && gameState.gameStage === 'showdown', isWinner);
                }
            });

            const potText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            potText.setAttribute('x', '400');
            potText.setAttribute('y', '400');
            potText.setAttribute('text-anchor', 'middle');
            potText.setAttribute('fill', '#fff');
            potText.setAttribute('font-size', '20');
            potText.textContent = `Pot: ${gameState.pot}`;
            svg.appendChild(potText);

            // Enable/disable buttons based on turn
            const isMyTurn = gameState.players[gameState.currentPlayerIndex]?.id === myPlayerId;
            betBtn.disabled = !isMyTurn || gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown' || gameState.hasBetThisRound.has(myPlayerId);
            checkBtn.disabled = !isMyTurn || gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown' || gameState.hasBetThisRound.has(myPlayerId);
            foldBtn.disabled = !isMyTurn || gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown';
            nextBtn.disabled = gameState.hasBetThisRound.size !== gameState.players.length || !isMyTurn;
        }

        function drawCard(card, x, y, dim = false, highlight = false) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', '60');
            rect.setAttribute('height', '80');
            rect.setAttribute('fill', '#fff');
            rect.setAttribute('stroke', '#333');
            rect.setAttribute('stroke-width', '2');
            rect.setAttribute('rx', '5');
            if (dim) rect.setAttribute('filter', 'url(#dim)');
            if (highlight) {
                rect.setAttribute('filter', 'url(#glow)');
                rect.setAttribute('stroke', '#ffd700');
                rect.setAttribute('stroke-width', '3');
            }
            svg.appendChild(rect);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x + 30);
            text.setAttribute('y', y + 45);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', card.includes('♥') || card.includes('♦') ? '#d32f2f' : '#000');
            text.setAttribute('font-size', '20');
            text.textContent = card;
            if (dim) text.setAttribute('filter', 'url(#dim)');
            svg.appendChild(text);
        }

        function sitDown() {
            const name = prompt("Enter your name:", "Player");
            if (!name) return;
            const chips = parseInt(prompt("Enter your starting chips (min 10):", "100")) || 100;
            socket.emit('sitDown', { name, chips: Math.max(10, chips) });
            sitDownBtn.style.display = 'none';
        }

        function toggleBetOptions() {
            if (betBtn.disabled) return;
            betOptions.style.display = betOptions.style.display === 'flex' ? 'none' : 'flex';
        }

        function bet(amount) {
            socket.emit('bet', amount);
            betOptions.style.display = 'none';
            clearTimer();
        }

        function betAllIn() {
            const player = gameState.players.find(p => p.id === myPlayerId);
            if (player) bet(player.chips);
        }

        function betCustom() {
            const amount = parseInt(document.getElementById('customBet').value);
            if (!isNaN(amount) && amount > 0) bet(amount);
        }

        function check() {
            socket.emit('check');
            clearTimer();
        }

        function fold() {
            socket.emit('fold');
            clearTimer();
        }

        function advanceGame() {
            socket.emit('advance');
            clearTimer();
        }

        function togglePastHands() {
            pastHandsMenu.style.display = pastHandsMenu.style.display === 'block' ? 'none' : 'block';
            updatePastHandsMenu();
        }

        function updatePastHandsMenu() {
            pastHandsMenu.innerHTML = '<h3>Past Hands</h3>';
            gameState.pastHands.forEach((hand, index) => {
                const entry = document.createElement('div');
                entry.className = 'hand-entry';
                entry.innerHTML = `
                    <strong>Hand ${index + 1} (Winner: ${hand.winner}, Pot: ${hand.pot})</strong><br>
                    Community: ${hand.communityCards.join(', ')}<br>
                    Preflop: ${hand.bets.preflop.map(b => `${b.player}: ${b.amount}`).join(', ') || 'None'}<br>
                    Flop: ${hand.bets.flop.map(b => `${b.player}: ${b.amount}`).join(', ') || 'None'}<br>
                    Turn: ${hand.bets.turn.map(b => `${b.player}: ${b.amount}`).join(', ') || 'None'}<br>
                    River: ${hand.bets.river.map(b => `${b.player}: ${b.amount}`).join(', ') || 'None'}<br>
                    Players: ${hand.players.map(p => `${p.name} (${p.cards.join(', ')}, ${p.chips} chips)`).join('; ')}
                `;
                pastHandsMenu.appendChild(entry);
            });
        }

        function startTimer() {
            if (gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown' || gameState.players.length === 0) return;
            if (gameState.players[gameState.currentPlayerIndex]?.id !== myPlayerId) return; // Only start timer for my turn
            clearTimer();
            let timeLeft = 15;
            const progress = document.querySelector('.timer-progress');
            if (progress) progress.style.width = '60px';

            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                if (progress) progress.style.width = `${(timeLeft / 15) * 60}px`;
                if (timeLeft <= 0) {
                    clearTimer();
                    if (gameState.currentHandBets[gameState.gameStage].length > 0 && !gameState.hasBetThisRound.has(myPlayerId)) {
                        fold();
                    } else {
                        check();
                    }
                }
            }, 100);
        }

        function clearTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
    </script>
</body>
</html>
