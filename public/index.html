<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same, adding some new styles -->
    <style>
        /* Previous styles remain, adding new ones */
        #betPopup {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
            z-index: 20;
        }
        .open-seat {
            opacity: 0.6;
            cursor: pointer;
        }
        #spectatorCount {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure with slight modifications -->
    <svg id="pokerSvg" viewBox="0 0 800 600"></svg>
    <div id="controls">
        <button id="sitDownBtn" onclick="sitDown()" style="display:none">Sit Down</button>
        <!-- Other buttons remain the same -->
        <div id="betPopup">
            <button onclick="bet(10)">10</button>
            <button onclick="bet(Math.floor(gameState.pot / 4))">1/4 Pot</button>
            <button onclick="bet(Math.floor(gameState.pot / 2))">1/2 Pot</button>
            <button onclick="bet(gameState.pot)">Pot</button>
            <button onclick="betAllIn()">All-In</button>
            <input id="customBet" type="number" min="1" placeholder="Custom">
            <button onclick="betCustom()">Go</button>
        </div>
        <!-- Rest of controls remain -->
    </div>
    <div id="spectatorCount">
        <svg width="20" height="20" viewBox="0 0 20 20">
            <path d="M10 5C4 5 0 10 0 10s4 5 10 5 10-5 10-5-4-5-10-5zm0 8c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3z"/>
        </svg>
        <span id="spectatorNum">0</span>
    </div>

    <script>
        const socket = io();
        // Previous variable declarations remain
        const betPopup = document.getElementById('betPopup');

        let gameState = {
            players: [],
            communityCards: [],
            gameStage: 'waiting',
            pot: 0,
            currentPlayerIndex: 0,
            dealerIndex: 0,
            hasBetThisRound: new Set(),
            pastHands: [],
            currentHandBets: { preflop: [], flop: [], turn: [], river: [] },
            spectators: 0,
            smallBlind: 5,
            bigBlind: 10
        };
        let myPlayerId = null;
        let isSpectating = true;

        socket.on('update', (state) => {
            gameState = state;
            gameState.hasBetThisRound = new Set(state.hasBetThisRound);
            myPlayerId = socket.id;
            document.getElementById('spectatorNum').textContent = gameState.spectators;
            drawScene();
        });

        function drawScene() {
            svg.innerHTML = '';
            // Previous defs and table drawing remains

            // Draw 8 seats
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * 2 * Math.PI;
                const x = 400 + 250 * Math.cos(angle);
                const y = 300 + 150 * Math.sin(angle);
                
                const player = gameState.players[i];
                if (!player) {
                    const seat = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    seat.setAttribute('cx', x);
                    seat.setAttribute('cy', y);
                    seat.setAttribute('r', '30');
                    seat.setAttribute('fill', '#ccc');
                    seat.setAttribute('class', 'open-seat');
                    seat.onclick = () => sitDownAtSeat(i);
                    svg.appendChild(seat);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', y + 5);
                    text.setAttribute('text-anchor', 'middle');
                    text.textContent = 'Open';
                    svg.appendChild(text);
                    continue;
                }

                // Draw player info (modified for blinds)
                if (i === gameState.dealerIndex) {
                    // Dealer indicator remains
                }

                if (player.cards) {
                    const showCards = player.id === myPlayerId || gameState.gameStage === 'showdown';
                    const isWinner = gameState.gameStage === 'showdown' && i === gameState.currentPlayerIndex;
                    const yOffset = i === 0 ? 270 : y - 25; // Align Player 1 with community cards
                    drawCard(showCards ? player.cards[0] : '?', x - 45, yOffset, !isWinner && gameState.gameStage === 'showdown', isWinner);
                    drawCard(showCards ? player.cards[1] : '?', x + 15, yOffset, !isWinner && gameState.gameStage === 'showdown', isWinner);
                }

                // Add blind indicators
                const blindText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                blindText.setAttribute('x', x);
                blindText.setAttribute('y', y + 100);
                blindText.setAttribute('text-anchor', 'middle');
                blindText.setAttribute('font-size', '12');
                if (i === (gameState.dealerIndex + 1) % gameState.players.length) {
                    blindText.textContent = 'SB';
                } else if (i === (gameState.dealerIndex + 2) % gameState.players.length) {
                    blindText.textContent = 'BB';
                }
                svg.appendChild(blindText);
            }

            // Button controls
            const isMyTurn = gameState.players[gameState.currentPlayerIndex]?.id === myPlayerId;
            const myPlayer = gameState.players.find(p => p.id === myPlayerId);
            betBtn.disabled = !isMyTurn || !myPlayer || gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown';
            checkBtn.disabled = !isMyTurn || !myPlayer || gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown';
            foldBtn.disabled = !isMyTurn || !myPlayer || gameState.gameStage === 'waiting' || gameState.gameStage === 'showdown';
            nextBtn.disabled = gameState.hasBetThisRound.size !== gameState.players.length || !isMyTurn;
            sitDownBtn.style.display = isSpectating && gameState.players.length < 8 ? 'block' : 'none';
        }

        function sitDownAtSeat(seatIndex) {
            if (!isSpectating) return;
            const name = prompt("Enter your name:", "Player");
            if (!name) return;
            const chips = parseInt(prompt("Enter your starting chips (min 10):", "100")) || 100;
            socket.emit('sitDown', { name, chips: Math.max(10, chips), seat: seatIndex });
            isSpectating = false;
        }

        function toggleBetOptions() {
            if (betBtn.disabled) return;
            betPopup.style.display = betPopup.style.display === 'block' ? 'none' : 'block';
        }

        function bet(amount) {
            const myPlayer = gameState.players.find(p => p.id === myPlayerId);
            if (myPlayer && amount <= myPlayer.chips) {
                socket.emit('bet', amount);
                betPopup.style.display = 'none';
            }
        }

        function advanceGame() {
            // Rotate dealer and blinds
            gameState.dealerIndex = (gameState.dealerIndex + 1) % gameState.players.length;
            socket.emit('advance');
        }

        // Initial blinds
        socket.on('connect', () => {
            if (gameState.players.length >= 2 && gameState.gameStage === 'waiting') {
                const smallBlindIndex = (gameState.dealerIndex + 1) % gameState.players.length;
                const bigBlindIndex = (gameState.dealerIndex + 2) % gameState.players.length;
                socket.emit('bet', { amount: gameState.smallBlind, playerIndex: smallBlindIndex, auto: true });
                socket.emit('bet', { amount: gameState.bigBlind, playerIndex: bigBlindIndex, auto: true });
            }
        });

        // Rest of the functions remain similar with minor adjustments
    </script>
    <!-- Previous Cloudflare scripts remain -->
</body>
</html>